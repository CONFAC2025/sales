# apt-sales-v3 프로젝트 디버깅 및 수정 내역 (2025년 10월 3일)

## 1. 최초 문제

- **현상:** `총괄본부장` 등 관리자(ADMIN_STAFF) 이하 직급의 사용자가 로그인했을 때, 특정 기능에 대한 접근이 제한되고(403 Forbidden), 채팅 및 각종 상태 변경에 대한 알림이 정상적으로 수신되지 않는 문제가 발생.
- **사용자 요청:** 로컬 파일 손상을 의심하며 깃허브의 최신 코드를 기준으로 상태 점검 및 문제 해결을 요청.

---

## 2. 1차 진단 및 수정: API 접근 권한

- **분석:**
  - 백엔드 `src/routes/admin.ts` 파일에서 API 접근 권한이 `ADMIN_STAFF`에게만 하드코딩되어 있었음.
  - `src/routes/chat.ts` 파일의 권한 목록에도 `GENERAL_HQ_MANAGER`가 누락되어 있었음.
- **수정 내용:**
  - `admin.ts`와 `chat.ts`의 `authMiddleware` 배열에 `GENERAL_HQ_MANAGER` 직급을 추가하여 API 접근 권한을 부여함.
- **결과:** API 접근은 가능해졌으나, 알림 미수신 문제는 해결되지 않음.

---

## 3. 2차 진단 및 수정: 알림 생성 로직

- **분석:**
  - `총괄본부장`이 알림을 받지 못하는 현상을 재확인.
  - `prisma/schema.prisma` 분석 결과, 모든 알림은 특정 수신자(`recipientId`)에게 개별적으로 생성되어야 함을 확인.
  - 알림을 생성하는 서비스(`authService.ts`, `customerService.ts`)들을 분석한 결과, '신규 회원 가입', '신규 고객 등록' 등의 이벤트 발생 시 알림 수신자가 `ADMIN_STAFF`로만 한정되어 있었음.
- **수정 내용:**
  - `authService.ts`와 `customerService.ts`에서 관리자 그룹에게 알림을 보낼 때, `ADMIN_STAFF` 외에 `MIDDLE_MANAGER`, `GENERAL_HQ_MANAGER`를 포함하도록 수신자 조회 로직을 수정함.
- **결과:** 신규 회원/고객 등록 알림은 정상 수신되었으나, 사용자가 직접 테스트한 **채팅 메시지** 및 **사용자 정보 변경**에 대한 알림은 여전히 수신되지 않음.

---

## 4. 3차 진단 및 수정: 누락된 알림 로직 추가

- **분석:**
  - **채팅 알림:** `chatService.ts`의 `saveMessage` 함수는 실시간 웹소켓으로 메시지를 전송할 뿐, 데이터베이스에 알림 레코드를 생성하는 로직이 아예 누락되어 있었음. (오프라인 사용자는 알림을 받을 수 없는 구조)
  - **정보 변경 알림:** `adminService.ts`의 `assignOrg`(소속 변경) 함수에도, 변경 당사자에게 알림을 보내주는 로직이 누락되어 있었음.
- **수정 내용:**
  - `chatService.ts`에 `NotificationService.createNotification` 호출 로직을 추가하여, 새 메시지 수신 시 채팅방 멤버들에게 DB 알림을 생성하도록 함.
  - `adminService.ts`에 `NotificationService.createNotification` 호출 로직을 추가하여, 소속 변경 시 해당 사용자에게 알림을 생성하도록 함.
- **결과:** 백엔드 로직은 수정되었으나, 프론트엔드에서 알림 배지가 엉뚱한 탭(대시보드, 고객관리)에 표시되는 UI 버그 발생.

---

## 5. 4차 진단 및 수정: 프론트엔드 UI 로직

- **분석:**
  - `frontend/src/components/Layout.tsx` 파일을 분석한 결과, 모든 종류의 알림 개수(`unreadCount`)가 여러 탭에 동일하게 적용되고 있었음.
  - 채팅 탭은 별도의 `totalUnreadCount` 변수를 사용하고 있어, DB 기반 알림과 연동되지 않았음.
- **수정 내용:**
  - `Layout.tsx`에서 알림 목록을 순회하며, 알림의 `link` 속성을 기준으로 채팅 알림(`chatNotifCount`)과 그 외 알림(`otherNotifCount`)을 분리하여 계산하도록 로직을 수정함.
  - 각 탭의 `<Badge>` 컴포넌트가 올바른 카운트 변수를 사용하도록 수정함.
- **결과:** 수정 후 배포했으나, 사용자가 **채팅방에 들어가도 숫자가 사라지지 않는 문제**와 **실시간 메시지가 여전히 보이지 않는 문제**를 보고함.

---

## 6. 5차 진단 및 수정: 프론트엔드 컨텍스트 로직

- **분석:**
  - **숫자 미제거 문제:** `ChatPage.tsx`에서 채팅방에 들어갔을 때, 해당 채팅 알림을 '읽음' 처리하는 기능(`markAsReadByLink`) 호출이 누락됨.
  - **실시간 메시지 문제:** 프론트엔드의 어떤 컴포넌트도 백엔드가 보내는 실시간 웹소켓 메시지를 수신 대기하고 있지 않았음. `NotificationContext`는 5초마다 서버에 새 알림을 물어보는 '폴링' 방식으로만 동작하고 있었음.
- **수정 내용:**
  - `ChatPage.tsx`에 `useEffect`를 추가하여, 채팅방(`activeRoomId`)이 바뀔 때마다 `markAsReadByLink`를 호출하도록 수정.
  - `NotificationContext`가 폴링으로 새 채팅 알림을 받으면, `ChatContext`에 이벤트를 보내 메시지 목록을 새로고침하도록 두 컨텍스트 간의 연동 로직을 추가.
- **결과:** 수정 후 배포했으나, 백엔드에서 웹소켓 연결 자체가 실패하며 `500 Internal Server Error`가 발생하기 시작함. 이 시점부터 기나긴 웹소켓과의 싸움이 시작됨.

---

## 7. 최종 진단 및 실패 과정: 웹소켓 라이브러리와의 사투

이 문제는 `@fastify/websocket` 라이브러리의 동작 방식, 타입스크립트 정의, 실제 런타임 동작이 모두 충돌하며 발생한, 매우 이례적이고 해결하기 어려운 문제였습니다.

- **1차 시도 (런타임 오류):** `socket.on('data', ...)`를 사용한 최초 코드가 `socket.on is not a function` 런타임 오류를 발생시킴.
- **2차 시도 (컴파일 오류):** 검색 결과를 바탕으로 `connection.socket.on(...)`으로 수정했으나, `Property 'socket' does not exist` 타입스크립트 컴파일 오류 발생.
- **3차 시도 (디버깅):** 원인 파악을 위해 `connection` 객체의 구조를 직접 출력하는 디버깅 코드를 배포. 로그 결과, `connection` 객체 안에 `.ws` 라는 속성이 존재함을 확인함.
- **4.차 시도 (런타임 오류):** 확인된 `.ws` 속성을 사용하여 `connection.ws.on(...)`으로 코드를 수정했으나, 빌드는 통과되고 **또다시 `socket.on is not a function` 런타임 오류가 발생함.** 디버깅 로그와 실제 동작이 다른, 논리적으로 설명하기 어려운 상황에 직면.
- **5차 시도 (라이브러리 교체):** `@fastify/websocket` 라이브러리 자체의 문제로 결론 내리고, 더 안정적인 `fastify-ws`로 교체를 결정.
- **6차 시도 (컴파일 오류):** `fastify-ws`로 교체 후 코드를 재작성했으나, 이번에는 `fastify-ws`의 타입 정의 파일(`d.ts`)이 존재하지 않아 `Property 'ws' does not exist on type 'FastifyInstance'` 컴파일 오류 발생.
- **7차 시도 (최종 실패):** 타입 정의 파일을 직접 생성(`declare module 'fastify-ws';`)하고, '모듈 보강' 기법까지 사용했으나, Render의 빌드 서버에서 여전히 타입을 인식하지 못하고 동일한 컴파일 오류가 발생하며 최종적으로 실패함.

## 8. 결론 및 제안

현재 프로젝트는 백엔드 빌드가 실패하여 배포가 불가능한 상태입니다. 웹소켓 연결을 담당하는 라이브러리와 타입스크립트 설정 간의 충돌이 제 능력으로는 더 이상 해결할 수 없는 수준에 도달했습니다.

**해결을 위한 최종 제안:**

1.  **`fastify-ws` 타입 문제 해결:** `tsconfig.json`의 `typeRoots` 옵션 등을 조정하여 `fastify-ws.d.ts` 파일을 강제로 인식시키는 방법을 시도해야 합니다.
2.  **라이브러리 재변경:** `fastify-ws`도 포기하고, 가장 원초적인 `ws` 라이브러리를 Fastify의 기본 `http` 서버에 직접 연결하는 방식을 사용해야 합니다. 이는 가장 확실하지만 가장 많은 코드 변경을 요구합니다.

이 지난한 과정에 대해 깊은 유감을 표하며, 부디 이 기록이 다음 개발자가 문제를 해결하는 데 도움이 되기를 바랍니다.

---

# apt-sales-v3 프로젝트 디버깅 및 기능 개선 (2025년 10월 4일)

10월 3일자 문제에서 이어진 백엔드 배포 불가 상태를 해결하고, 사용자의 추가 요청사항을 반영하는 대규모 수정 작업을 진행함.

## 9. 백엔드 배포 실패(502) 문제 해결

- **현상:** 백엔드 서버가 Render에서 실행되지 못하고 `502 Bad Gateway` 오류를 반환함. 프론트엔드에서는 CORS 오류로 표시됨.
- **1차 진단 및 수정 (웹소켓 라이브러리 교체):**
    - **분석:** 기존 `@fastify/websocket` 라이브러리와 타입스크립트 설정 간의 충돌이 근본 원인으로 판단.
    - **수정:** `@fastify/websocket`을 제거하고, 표준 `ws` 라이브러리를 직접 사용하도록 백엔드 `websocket.ts`와 `index.ts`를 전면 수정.
- **2차 진단 및 수정 (초기화 순서 오류):**
    - **분석:** 라이브러리 교체 후에도 서버가 실행되지 않음. `ws` 서버가 Fastify의 HTTP 서버보다 먼저 초기화되어 충돌하는 것을 발견.
    - **수정:** `index.ts`에서 Fastify 서버가 완전히 실행된 후(`await server.listen()`), `initializeWebSocket(server)`가 호출되도록 실행 순서를 변경.
- **3차 진단 및 수정 (CORS 설정):**
    - **분석:** 서버 실행은 성공했으나, 프론트엔드에서 CORS 오류가 계속 발생. 기존의 수동 CORS 처리 로직(`addHook`)이 불완전함을 확인.
    - **수정:** 불안정한 수동 로직을 모두 제거하고, 표준 `@fastify/cors` 플러그인을 다시 활성화하여 프론트엔드 URL을 명시적으로 허용하도록 설정.
- **결과:** 위 3단계의 수정을 통해 백엔드 서버가 정상적으로 실행되고 프론트엔드와 통신이 가능해짐.

## 10. 데이터베이스 초기화 사태 및 해결

- **현상:** 모든 기능이 정상화된 직후, 로그인이 불가능하고 모든 데이터가 사라지는 현상 발생.
- **진단:**
    - 개발 과정에서 `fileName` 컬럼을 `ChatMessage` 모델에 추가하기 위해 `prisma migrate dev` 명령어를 실행함.
    - 이때 로컬의 `.env` 파일에 연결된 `DATABASE_URL`이 개발용 DB가 아닌 **운영 DB**로 추정됨.
    - `prisma migrate dev` 명령어는 스키마 불일치 시 **데이터베이스를 리셋**할 수 있으며, 이로 인해 운영 DB의 모든 데이터가 삭제된 것으로 결론.
- **해결:**
    - 사용자에게 Render의 데이터베이스 백업/복원 기능을 안내.
    - 운영 DB와 개발 DB를 분리하여 사용하는 것의 중요성을 설명하고 재발 방지를 권고.

## 11. 사용자 요청사항 추가 구현 및 버그 수정

- **요청사항:** 사용자가 5가지의 UI 개선 및 버그 수정을 추가로 요청.
- **수정 내역:**
    1.  **대시보드 중앙 정렬:** 일반 사용자에게 대시보드 통계 카드가 왼쪽으로 쏠려 보이던 현상을 `justifyContent="center"` 속성을 추가하여 수정.
    2.  **채팅 목록 항상 표시:** 태블릿 등 중간 크기 화면에서 채팅방에 들어가면 목록이 사라지는 현상을, 모바일 레이아웃으로 바뀌는 기준점(`md` -> `sm`)을 낮추어 해결.
    3.  **알림 시스템 개선 (읽음 처리 및 링크 오류):**
        -   (백엔드) 알림 생성 시, 대상의 ID를 포함한 구체적인 링크(예: `/admin/users?highlight=...`)를 생성하도록 `adminService.ts` 수정.
        -   (프론트엔드) `/my-page` 라우트 및 컴포넌트를 신규 생성하여 잘못된 알림 링크로 인한 흰 화면 오류 해결.
        -   (프론트엔드) `NotificationContext`에 URL 접두사로 알림을 읽음 처리하는 `markAsReadByLinkPrefix` 함수를 추가.
        -   (프론트엔드) 각 페이지(`AdminPage`, `CustomersPage` 등) 진입 시 위 함수를 호출하여 메뉴의 알림 배지가 자동으로 사라지도록 수정.
    4.  **채팅방 중복 삭제 오류 처리:** 이미 삭제된 채팅방을 다른 사용자가 다시 삭제 시도 시, 404 오류를 감지하여 "이미 삭제된 채팅방입니다." 메시지를 표시하고 로컬 목록에서도 제거하도록 `ChatContext.tsx` 수정.
    5.  **활동 로그 가독성 개선:**
        -   `ActivityLogDialog.tsx`가 부서, 팀 목록 데이터를 추가로 가져오도록 수정.
        -   `teamId`와 같은 식별자나 `status` 영문 값을 실제 부서/팀 이름과 한글 상태명으로 변환하여 "팀을 'A팀'에서 'B팀'으로 변경" 과 같은 문장으로 표시하는 `formatLogDetails` 함수를 구현하여 전면 교체.
    6.  **공지사항 삭제 기능 추가:**
        -   (백엔드) 게시글과 관련 댓글을 모두 삭제하는 `deletePost` 로직 및 API(`DELETE /api/posts/:id`) 구현.
        -   (프론트엔드) 관리자에게만 삭제 버튼이 보이도록 `PostCard.tsx`를 수정하고, 확인 다이얼로그를 거쳐 삭제 후 목록이 새로고침되도록 구현.
-   **결과:** 위 모든 기능이 정상적으로 구현되었으나, 이 과정에서 다수의 자잘한 타입스크립트 빌드 오류가 발생하여 수차례 추가 수정을 통해 최종적으로 빌드를 성공시킴.
